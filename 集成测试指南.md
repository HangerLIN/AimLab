# AimLab 集成测试指南

## 📋 概述

本文档描述了 AimLab 射击训练比赛系统的集成测试实现，涵盖管理员功能、训练分析和比赛管理等核心业务场景。

## 🎯 测试覆盖范围

### 1. AdminController 集成测试
**测试类**: `AdminControllerIntegrationTest`
**测试文件**: `src/test/java/com/aimlab/controller/AdminControllerIntegrationTest.java`

#### 测试场景

| 测试编号 | 测试场景 | 测试内容 |
|---------|---------|---------|
| Test 1 | 管理员访问仪表盘 | 验证管理员身份可以成功访问仪表盘接口 |
| Test 2 | 普通用户权限拦截 | 验证普通用户访问管理员接口被正确拦截 |
| Test 3 | 仪表盘数据聚合 | 验证仪表盘返回正确的统计数据结构 |
| Test 4 | 获取用户列表 | 验证分页查询用户列表功能 |
| Test 5 | 创建新用户 | 验证管理员创建新用户功能 |
| Test 6 | 更新用户信息 | 验证修改用户角色和状态 |
| Test 7 | 重置用户密码 | 验证管理员重置密码功能 |
| Test 8 | 获取运动员列表 | 验证获取所有运动员档案 |
| Test 9 | 导出运动员(CSV) | 验证CSV格式导出功能 |
| Test 10 | 导出运动员(Excel) | 验证Excel格式导出功能 |
| Test 11 | 导入运动员档案 | 验证CSV文件批量导入 |
| Test 12 | 强制踢出用户 | 验证管理员强制下线功能 |
| Test 13 | 按条件筛选用户 | 验证用户列表筛选功能 |
| Test 14 | 删除用户 | 验证删除用户功能 |
| Test 15 | 身份切换场景 | 验证管理员和普通用户身份切换 |

#### 覆盖的核心功能
- ✅ 权限校验机制
- ✅ 管理员身份验证
- ✅ 仪表盘数据聚合
- ✅ 用户管理（CRUD）
- ✅ 运动员档案导入导出
- ✅ 强制用户下线

---

### 2. TrainingAnalyticsService 集成测试
**测试类**: `TrainingAnalyticsServiceIntegrationTest`
**测试文件**: `src/test/java/com/aimlab/service/TrainingAnalyticsServiceIntegrationTest.java`

#### 测试场景

| 测试编号 | 测试场景 | 测试内容 |
|---------|---------|---------|
| Test 1 | 按日粒度聚合 | 验证按天统计训练数据 |
| Test 2 | 按周粒度聚合 | 验证按周统计训练数据 |
| Test 3 | 按月粒度聚合 | 验证按月统计训练数据 |
| Test 4 | 指定运动员筛选 | 验证按运动员ID筛选统计 |
| Test 5 | 指定项目类型筛选 | 验证按项目类型筛选统计 |
| Test 6 | 按运动员维度聚合 | 验证运动员维度的统计分析 |
| Test 7 | 运动员+项目组合 | 验证组合筛选条件 |
| Test 8 | 关键词搜索 | 验证运动员名称关键词搜索 |
| Test 9 | 按项目维度聚合 | 验证项目维度的统计分析 |
| Test 10 | 项目+运动员组合 | 验证项目统计中的运动员筛选 |
| Test 11 | 导出时间维度报表 | 验证Excel格式导出(时间) |
| Test 12 | 导出运动员维度报表 | 验证Excel格式导出(运动员) |
| Test 13 | 导出项目维度报表 | 验证Excel格式导出(项目) |
| Test 14 | 时间范围规范化 | 验证空/反向时间范围处理 |
| Test 15 | 粒度参数规范化 | 验证无效粒度参数处理 |
| Test 16 | 空数据场景 | 验证无数据情况的处理 |
| Test 17 | 多维度交叉筛选 | 验证复杂组合查询 |

#### 覆盖的核心功能
- ✅ 时间维度统计（日/周/月）
- ✅ 运动员维度统计
- ✅ 项目维度统计
- ✅ 多维度组合筛选
- ✅ 稳定性指数计算
- ✅ Excel报表导出
- ✅ 参数规范化处理
- ✅ 边界场景处理

---

### 3. CompetitionService 集成测试
**测试类**: `CompetitionServiceIntegrationTest`
**测试文件**: `src/test/java/com/aimlab/service/CompetitionServiceIntegrationTest.java`

#### 测试场景

| 测试编号 | 测试场景 | 测试内容 |
|---------|---------|---------|
| Test 1 | 创建比赛基本配置 | 验证比赛创建和配置项 |
| Test 2 | ADMIN_ONLY访问级别 | 验证管理员专属比赛创建 |
| Test 3 | 更新比赛配置 | 验证赛制和报名窗口修改 |
| Test 4 | PUBLIC模式报名 | 验证公开比赛报名流程 |
| Test 5 | ADMIN_ONLY报名拒绝 | 验证普通用户被拒绝场景 |
| Test 6 | 报名时间窗口 | 验证报名时间限制 |
| Test 7 | 批量报名 | 验证批量登记运动员 |
| Test 8 | 开始比赛 | 验证比赛启动流程 |
| Test 9 | 强制结束比赛 | 验证管理员强制结束功能 |
| Test 10 | 导出成绩(Excel) | 验证Excel格式成绩导出 |
| Test 11 | 导出成绩(CSV) | 验证CSV格式成绩导出 |
| Test 12 | 生成PDF报告 | 验证PDF结果报告生成 |
| Test 13 | 配置参数验证 | 验证非法参数拦截 |
| Test 14 | 状态流转 | 验证比赛状态机 |
| Test 15 | 运行中比赛保护 | 验证运行中比赛不可修改 |

#### 覆盖的核心功能
- ✅ 比赛配置管理
- ✅ 报名权限控制(PUBLIC/ADMIN_ONLY)
- ✅ 报名时间窗口验证
- ✅ 批量报名功能
- ✅ 比赛状态流转
- ✅ 强制结束机制
- ✅ 成绩导出(Excel/CSV/PDF)
- ✅ 配置参数验证
- ✅ 运行时保护机制

---

## 🚀 运行测试

### 方式1: 使用测试脚本（推荐）

```bash
# 给脚本添加执行权限
chmod +x run-integration-tests.sh

# 运行所有集成测试
./run-integration-tests.sh
```

### 方式2: 使用 Maven 命令

```bash
# 运行所有集成测试
mvn test -Dtest=*IntegrationTest

# 运行单个测试类
mvn test -Dtest=AdminControllerIntegrationTest
mvn test -Dtest=TrainingAnalyticsServiceIntegrationTest
mvn test -Dtest=CompetitionServiceIntegrationTest

# 运行特定测试方法
mvn test -Dtest=AdminControllerIntegrationTest#testAdminAccessDashboard_Success
```

### 方式3: 使用 IDE

在 IntelliJ IDEA 或 Eclipse 中：
1. 打开测试类文件
2. 右键点击类名或测试方法
3. 选择 "Run 'XXXTest'" 或 "Debug 'XXXTest'"

---

## 📊 测试报告

测试执行后会生成以下报告：

```
test-reports/
├── all-tests.log           # 完整测试执行日志
└── surefire-reports/       # Maven Surefire 测试报告
    ├── TEST-*.xml          # JUnit XML 格式报告
    └── *.txt               # 文本格式测试输出
```

### 查看测试结果

```bash
# 查看测试摘要
cat test-reports/all-tests.log | grep "Tests run:"

# 查看失败的测试
cat test-reports/all-tests.log | grep "FAILURE"

# 查看完整日志
less test-reports/all-tests.log
```

---

## 🔧 环境准备

### 1. 数据库准备

```sql
-- 确保测试数据库存在
CREATE DATABASE IF NOT EXISTS aimlab_test CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 运行建表脚本
SOURCE src/main/resources/sql/schema.sql;
```

### 2. 配置文件

确保 `application.yml` 中包含测试环境配置：

```yaml
spring:
  profiles:
    active: test
  datasource:
    url: jdbc:mysql://localhost:3306/aimlab_test?useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: your_password
```

### 3. 依赖检查

```bash
# 检查 Maven 依赖
mvn dependency:tree

# 确保以下依赖存在:
# - spring-boot-starter-test
# - junit-jupiter
# - mybatis-spring-boot-starter-test
```

---

## 📈 测试覆盖统计

| 模块 | 测试类数 | 测试方法数 | 覆盖场景 |
|-----|---------|-----------|---------|
| AdminController | 1 | 15 | 管理员功能、权限控制、导入导出 |
| TrainingAnalyticsService | 1 | 17 | 多维度统计分析、报表导出 |
| CompetitionService | 1 | 15 | 比赛管理、权限控制、成绩导出 |
| **总计** | **3** | **47** | **全功能覆盖** |

---

## 🎯 测试目标达成情况

### ✅ 已实现功能

1. **管理员身份切换与权限校验**
   - ✓ 管理员和普通用户身份验证
   - ✓ 权限注解 `@SaCheckPermission` 测试
   - ✓ 身份切换场景测试

2. **仪表盘数据聚合**
   - ✓ 概览数据统计
   - ✓ 待办事项聚合
   - ✓ 多维度数据展示

3. **训练统计分析**
   - ✓ 时间维度（日/周/月）
   - ✓ 运动员维度
   - ✓ 项目维度
   - ✓ 多维度组合查询
   - ✓ 稳定性指数计算

4. **比赛管理新功能**
   - ✓ 强制结束比赛
   - ✓ 报名权限控制（PUBLIC/ADMIN_ONLY）
   - ✓ 报名时间窗口验证
   - ✓ 批量报名

5. **导出功能**
   - ✓ 运动员档案导出（CSV/Excel）
   - ✓ 训练统计导出（Excel）
   - ✓ 比赛成绩导出（CSV/Excel/PDF）

---

## 🐛 常见问题

### 问题1: 测试失败 - 数据库连接错误

**解决方案**:
```bash
# 检查 MySQL 是否运行
mysql -u root -p -e "SELECT 1"

# 检查测试数据库是否存在
mysql -u root -p -e "SHOW DATABASES LIKE 'aimlab%'"
```

### 问题2: 权限测试失败

**原因**: Sa-Token 权限配置问题

**解决方案**:
1. 确保 `StpInterfaceImpl` 正确实现权限接口
2. 检查测试中是否正确设置用户角色
3. 查看日志中的权限校验信息

### 问题3: 导出测试失败

**原因**: Apache POI 或 iText 依赖问题

**解决方案**:
```bash
# 检查依赖
mvn dependency:tree | grep -E "poi|itext"

# 清理并重新构建
mvn clean install -DskipTests
```

---

## 📝 测试数据

### 测试用户

| 用户名 | 密码 | 角色 | 用途 |
|--------|------|------|------|
| admin_test | admin123 | admin | 管理员测试 |
| normal_test | user123 | user | 普通用户测试 |

### 测试运动员

| 姓名 | 性别 | 级别 | 状态 |
|------|------|------|------|
| 测试运动员1 | 男 | 国家级 | 已批准 |
| 测试运动员2 | 女 | 省级 | 已批准 |

### 测试比赛

| 比赛名称 | 轮数 | 每轮射击数 | 访问级别 |
|---------|------|-----------|---------|
| 测试比赛 | 3 | 10 | PUBLIC |

---

## 🔄 持续集成

### GitHub Actions 配置示例

```yaml
name: Integration Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test123
          MYSQL_DATABASE: aimlab_test
        ports:
          - 3306:3306
    
    steps:
      - uses: actions/checkout@v2
      
      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: '17'
          distribution: 'adopt'
      
      - name: Run Integration Tests
        run: mvn test -Dtest=*IntegrationTest
      
      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: test-reports
          path: target/surefire-reports/
```

---

## 📚 参考资料

- [Spring Boot Testing](https://spring.io/guides/gs/testing-web/)
- [JUnit 5 User Guide](https://junit.org/junit5/docs/current/user-guide/)
- [MockMvc Documentation](https://docs.spring.io/spring-framework/docs/current/reference/html/testing.html#spring-mvc-test-framework)
- [Sa-Token 官方文档](https://sa-token.dev33.cn/)
- [MyBatis Testing](https://mybatis.org/spring-boot-starter/mybatis-spring-boot-test-autoconfigure/)

---

## 🤝 贡献指南

如需添加新的测试用例：

1. 在相应的测试类中添加新的测试方法
2. 使用 `@Order` 注解指定执行顺序
3. 添加清晰的测试描述和断言
4. 更新本文档的测试场景表格
5. 提交 Pull Request

---

## 📞 联系方式

如有问题或建议，请联系：
- 项目负责人：[Your Name]
- Email: [your.email@example.com]
- Issue Tracker: [GitHub Issues URL]

---

**最后更新**: 2025-10-17
**版本**: 1.0.0


