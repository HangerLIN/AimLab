# 运动员数据分析功能增强设计文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | v1.0 |
| 创建日期 | 2025-12-12 |
| 适用系统 | AimLab 射击训练比赛系统 |

---

## 一、功能概述

### 1.1 目标

增强运动员数据分析能力，实现：
- **多维度对比分析**：同级别运动员关键指标横向对比（雷达图+柱状图）
- **历史趋势分析**：周度成绩变化曲线、移动平均线、趋势预测
- **交互式图表**：时间范围选择、指标筛选、数据导出

### 1.2 技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| 前端图表 | Chart.js 4.5.0 | 雷达图、柱状图、折线图 |
| 前端框架 | Vue 3 + Composition API | 现有技术栈 |
| 后端框架 | Spring Boot 2.7.14 | 现有技术栈 |
| 数据导出 | Apache POI | Excel导出 |

---

## 二、系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    前端 (Vue 3 + Chart.js)                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ AthleteCompare  │  │  TrendAnalysis  │  │ AnalyticsDashboard│ │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  │
│           └────────────────────┴────────────────────┘           │
│                    analytics.js (API封装)                        │
└─────────────────────────────────┬───────────────────────────────┘
                                  │ HTTP REST API
┌─────────────────────────────────┼───────────────────────────────┐
│                     后端 (Spring Boot)                           │
│  ┌──────────────────────────────┴──────────────────────────────┐│
│  │                  AnalyticsController                         ││
│  │  POST /api/analytics/compare     - 对比分析                   ││
│  │  GET  /api/analytics/trend/{id}  - 趋势分析                   ││
│  │  GET  /api/analytics/*/export    - 数据导出                   ││
│  └──────────────────────────────┬──────────────────────────────┘│
│  ┌──────────────────────────────┴──────────────────────────────┐│
│  │              AdvancedAnalyticsService                        ││
│  │  - compareAthletes()       运动员对比                         ││
│  │  - getTrendAnalysis()      趋势分析                          ││
│  │  - calculateMovingAverage() 移动平均                         ││
│  │  - predictTrend()          线性趋势预测                       ││
│  └──────────────────────────────┬──────────────────────────────┘│
│  ┌──────────────────────────────┴──────────────────────────────┐│
│  │              AdvancedAnalyticsMapper + XML                   ││
│  └──────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

---

## 三、API接口设计

### 3.1 运动员对比分析

**POST /api/analytics/compare**

请求体：
```json
{
  "athleteIds": [1, 2, 3],      // 可选，指定运动员ID
  "level": "省级",              // 可选，按级别筛选
  "startTime": "2024-01-01T00:00:00",
  "endTime": "2024-12-31T23:59:59",
  "projectType": "10米气步枪",  // 可选
  "maxCount": 5                 // 最大对比人数
}
```

响应：
```json
{
  "success": true,
  "data": [
    {
      "athleteId": 1,
      "athleteName": "张三",
      "athleteLevel": "省级",
      "avgScore": 8.75,
      "maxScore": 10,
      "minScore": 6,
      "stabilityIndex": 1.23,
      "stabilityScore": 87.7,
      "totalShots": 500,
      "sessionCount": 25,
      "perfectRate": 15.2,
      "highScoreRate": 68.5
    }
  ],
  "count": 5
}
```

### 3.2 趋势分析

**GET /api/analytics/trend/{athleteId}**

参数：
- `weeks`: 分析周数（默认12）
- `projectType`: 项目类型（可选）

响应：
```json
{
  "success": true,
  "data": {
    "athleteId": 1,
    "athleteName": "张三",
    "analyzedWeeks": 12,
    "trendDirection": "UP",
    "trendSlope": 0.05,
    "trendData": [
      {
        "period": "2024-W01",
        "avgScore": 8.2,
        "maxScore": 10,
        "minScore": 6,
        "stabilityIndex": 1.5,
        "movingAverage": 8.1,
        "totalShots": 50,
        "sessionCount": 3,
        "isPredicted": false
      }
    ],
    "predictions": [
      {
        "period": "预测第1周",
        "avgScore": 8.8,
        "predictedScore": 8.8,
        "isPredicted": true
      }
    ],
    "summary": {
      "periodHighest": 9.2,
      "periodLowest": 7.8,
      "periodAverage": 8.5,
      "improvement": 0.6,
      "bestWeek": "2024-W10",
      "worstWeek": "2024-W02"
    }
  }
}
```

### 3.3 数据导出

**POST /api/analytics/compare/export** - 导出对比数据（Excel）
**GET /api/analytics/trend/{athleteId}/export** - 导出趋势数据（Excel）

---

## 四、后端实现

### 4.1 新增文件清单

| 文件路径 | 说明 |
|----------|------|
| `src/main/java/com/aimlab/dto/AthleteCompareDTO.java` | 对比数据DTO |
| `src/main/java/com/aimlab/dto/TrendDataDTO.java` | 趋势数据点DTO |
| `src/main/java/com/aimlab/dto/TrendAnalysisResultDTO.java` | 趋势分析结果DTO |
| `src/main/java/com/aimlab/dto/CompareRequestDTO.java` | 对比请求DTO |
| `src/main/java/com/aimlab/mapper/AdvancedAnalyticsMapper.java` | Mapper接口 |
| `src/main/resources/mapper/AdvancedAnalyticsMapper.xml` | SQL映射 |
| `src/main/java/com/aimlab/service/AdvancedAnalyticsService.java` | 服务层 |
| `src/main/java/com/aimlab/controller/AnalyticsController.java` | 控制器 |

### 4.2 核心DTO

#### AthleteCompareDTO.java

```java
@Data
public class AthleteCompareDTO {
    private Long athleteId;
    private String athleteName;
    private String athleteLevel;
    private BigDecimal avgScore;
    private BigDecimal maxScore;
    private BigDecimal minScore;
    private BigDecimal stabilityIndex;
    private Long totalShots;
    private Long sessionCount;
    private BigDecimal perfectRate;      // 10环率
    private BigDecimal highScoreRate;    // 9环以上率
    private BigDecimal stabilityScore;   // 稳定性得分(用于雷达图)
}
```

#### TrendDataDTO.java

```java
@Data
public class TrendDataDTO {
    private String period;           // 周期标识(2024-W01)
    private Integer weekNumber;      // 周数编号
    private LocalDate weekStartDate; // 周开始日期
    private BigDecimal avgScore;
    private BigDecimal maxScore;
    private BigDecimal minScore;
    private BigDecimal stabilityIndex;
    private Long totalShots;
    private Long sessionCount;
    private BigDecimal movingAverage;   // 3周移动平均
    private BigDecimal predictedScore;  // 预测值
    private Boolean isPredicted;        // 是否为预测数据
}
```

### 4.3 核心SQL

#### 运动员对比查询

```sql
SELECT 
    a.id AS athlete_id,
    a.name AS athlete_name,
    a.level AS athlete_level,
    ROUND(AVG(sr.score), 2) AS avg_score,
    MAX(sr.score) AS max_score,
    MIN(sr.score) AS min_score,
    ROUND(IFNULL(STDDEV_POP(sr.score), 0), 2) AS stability_index,
    COUNT(*) AS total_shots,
    COUNT(DISTINCT sr.training_session_id) AS session_count,
    ROUND(SUM(CASE WHEN sr.score = 10 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS perfect_rate,
    ROUND(SUM(CASE WHEN sr.score >= 9 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS high_score_rate
FROM athletes a
INNER JOIN shooting_records sr ON a.id = sr.athlete_id
WHERE sr.record_type = 'TRAINING'
  AND a.level = #{level}
  AND sr.shot_at BETWEEN #{startTime} AND #{endTime}
GROUP BY a.id, a.name, a.level
HAVING COUNT(*) >= 10
ORDER BY avg_score DESC
LIMIT #{limit};
```

#### 周度趋势查询

```sql
SELECT 
    DATE_FORMAT(sr.shot_at, '%Y-W%v') AS week_period,
    YEARWEEK(sr.shot_at, 1) AS week_number,
    MIN(DATE(sr.shot_at)) AS week_start_date,
    ROUND(AVG(sr.score), 2) AS avg_score,
    MAX(sr.score) AS max_score,
    MIN(sr.score) AS min_score,
    ROUND(IFNULL(STDDEV_POP(sr.score), 0), 2) AS stability_index,
    COUNT(*) AS total_shots,
    COUNT(DISTINCT sr.training_session_id) AS session_count
FROM shooting_records sr
WHERE sr.athlete_id = #{athleteId}
  AND sr.record_type = 'TRAINING'
  AND sr.shot_at >= DATE_SUB(NOW(), INTERVAL #{weeks} WEEK)
GROUP BY week_period, week_number
HAVING COUNT(*) >= 5
ORDER BY week_number ASC;
```

### 4.4 服务层核心算法

#### 移动平均计算

```java
private void calculateMovingAverage(List<TrendDataDTO> data, int window) {
    for (int i = 0; i < data.size(); i++) {
        int start = Math.max(0, i - window + 1);
        BigDecimal sum = BigDecimal.ZERO;
        int count = 0;
        
        for (int j = start; j <= i; j++) {
            if (data.get(j).getAvgScore() != null) {
                sum = sum.add(data.get(j).getAvgScore());
                count++;
            }
        }
        
        if (count > 0) {
            data.get(i).setMovingAverage(
                sum.divide(BigDecimal.valueOf(count), 2, RoundingMode.HALF_UP));
        }
    }
}
```

#### 趋势斜率计算（简单线性回归）

```java
private BigDecimal calculateTrendSlope(List<TrendDataDTO> data) {
    if (data.size() < 2) return BigDecimal.ZERO;
    
    int n = data.size();
    double sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
    
    for (int i = 0; i < n; i++) {
        double x = i;
        double y = data.get(i).getAvgScore() != null ? 
                data.get(i).getAvgScore().doubleValue() : 0;
        sumX += x;
        sumY += y;
        sumXY += x * y;
        sumX2 += x * x;
    }
    
    double denominator = n * sumX2 - sumX * sumX;
    if (denominator == 0) return BigDecimal.ZERO;
    
    double slope = (n * sumXY - sumX * sumY) / denominator;
    return BigDecimal.valueOf(slope).setScale(4, RoundingMode.HALF_UP);
}
```

#### 趋势预测

```java
private List<TrendDataDTO> predictFutureWeeks(List<TrendDataDTO> data, 
                                               int predictWeeks, 
                                               BigDecimal slope) {
    List<TrendDataDTO> predictions = new ArrayList<>();
    TrendDataDTO lastData = data.get(data.size() - 1);
    BigDecimal lastScore = lastData.getMovingAverage() != null ? 
            lastData.getMovingAverage() : lastData.getAvgScore();
    
    for (int i = 1; i <= predictWeeks; i++) {
        TrendDataDTO prediction = new TrendDataDTO();
        prediction.setPeriod("预测第" + i + "周");
        prediction.setIsPredicted(true);
        
        // 线性预测: y = lastScore + slope * i
        BigDecimal predictedScore = lastScore.add(slope.multiply(BigDecimal.valueOf(i)));
        // 限制在0-10范围
        predictedScore = predictedScore.max(BigDecimal.ZERO).min(BigDecimal.TEN);
        prediction.setPredictedScore(predictedScore.setScale(2, RoundingMode.HALF_UP));
        prediction.setAvgScore(prediction.getPredictedScore());
        
        predictions.add(prediction);
    }
    return predictions;
}
```

---

## 五、前端实现

### 5.1 新增文件清单

| 文件路径 | 说明 |
|----------|------|
| `src/api/analytics.js` | API封装 |
| `src/views/AthleteCompare.vue` | 运动员对比页面 |
| `src/views/TrendAnalysis.vue` | 趋势分析页面 |
| `src/views/AnalyticsDashboard.vue` | 数据分析仪表盘 |

### 5.2 API封装 (analytics.js)

```javascript
import apiClient from './index';

// 运动员对比分析
export function compareAthletes(params) {
  return apiClient.post('/analytics/compare', params);
}

// 趋势分析
export function getTrendAnalysis(athleteId, weeks = 12, projectType = null) {
  const params = { weeks };
  if (projectType) params.projectType = projectType;
  return apiClient.get(`/analytics/trend/${athleteId}`, { params });
}

// 导出对比数据
export function exportCompareData(params) {
  return apiClient.post('/analytics/compare/export', params, {
    responseType: 'blob'
  });
}

// 导出趋势数据
export function exportTrendData(athleteId, weeks = 12, projectType = null) {
  const params = { weeks };
  if (projectType) params.projectType = projectType;
  return apiClient.get(`/analytics/trend/${athleteId}/export`, {
    params,
    responseType: 'blob'
  });
}
```

### 5.3 图表配置

#### 雷达图配置

```javascript
const radarConfig = {
  type: 'radar',
  data: {
    labels: ['平均成绩', '最高成绩', '稳定性', '10环率', '高分率', '训练量'],
    datasets: athletes.map((athlete, index) => ({
      label: athlete.athleteName,
      data: [
        athlete.avgScore * 10,      // 归一化到0-100
        athlete.maxScore * 10,
        athlete.stabilityScore,
        athlete.perfectRate,
        athlete.highScoreRate,
        Math.min(athlete.sessionCount * 5, 100)
      ],
      backgroundColor: colors[index].replace('0.7', '0.2'),
      borderColor: colors[index],
      borderWidth: 2
    }))
  },
  options: {
    scales: {
      r: { beginAtZero: true, max: 100 }
    }
  }
};
```

#### 趋势折线图配置

```javascript
const trendConfig = {
  type: 'line',
  data: {
    labels: [...historicalPeriods, ...predictionPeriods],
    datasets: [
      {
        label: '实际成绩',
        data: actualScores,
        borderColor: 'rgba(16, 185, 129, 1)',
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
        fill: true,
        tension: 0.3
      },
      {
        label: '移动平均',
        data: movingAverages,
        borderColor: 'rgba(59, 130, 246, 1)',
        borderDash: [5, 5],
        fill: false
      },
      {
        label: '预测值',
        data: predictedScores,
        borderColor: 'rgba(245, 158, 11, 1)',
        borderDash: [10, 5],
        pointStyle: 'triangle'
      }
    ]
  },
  options: {
    scales: {
      y: { min: 0, max: 10 }
    }
  }
};
```

### 5.4 交互功能

| 功能 | 实现方式 |
|------|----------|
| 时间范围选择 | Element Plus DatePicker (daterange) |
| 级别筛选 | Element Plus Select |
| 指标切换 | Element Plus Radio Group |
| 数据导出 | Blob下载 + Content-Disposition |
| 图表缩放 | Chart.js zoom plugin (可选) |

---

## 六、路由配置

```javascript
// router/index.js 新增路由
{
  path: '/analytics',
  component: MainLayout,
  children: [
    {
      path: 'compare',
      name: 'AthleteCompare',
      component: () => import('@/views/AthleteCompare.vue'),
      meta: { title: '运动员对比' }
    },
    {
      path: 'trend',
      name: 'TrendAnalysis',
      component: () => import('@/views/TrendAnalysis.vue'),
      meta: { title: '趋势分析' }
    },
    {
      path: '',
      name: 'AnalyticsDashboard',
      component: () => import('@/views/AnalyticsDashboard.vue'),
      meta: { title: '数据分析' }
    }
  ]
}
```

---

## 七、测试用例

### 7.1 后端测试

| 测试场景 | 预期结果 |
|----------|----------|
| 对比同级别5名运动员 | 返回5条数据，按avgScore降序 |
| 对比指定运动员ID列表 | 返回指定运动员数据 |
| 空数据场景 | 返回空列表，不报错 |
| 趋势分析12周 | 返回12周数据+2周预测 |
| 移动平均计算 | 第3周开始有3周移动平均 |
| 趋势预测 | 预测值在0-10范围内 |

### 7.2 前端测试

| 测试场景 | 预期结果 |
|----------|----------|
| 雷达图渲染 | 5名运动员显示5个多边形 |
| 柱状图指标切换 | 切换后图表数据更新 |
| 趋势图预测线 | 预测数据使用虚线显示 |
| 导出Excel | 下载文件名包含日期 |

---

## 八、实施计划

| 阶段 | 任务 | 工时 |
|------|------|------|
| 1 | 后端DTO和Mapper | 0.5天 |
| 2 | 后端Service实现 | 1天 |
| 3 | 后端Controller和测试 | 0.5天 |
| 4 | 前端API封装 | 0.5天 |
| 5 | 前端对比分析页面 | 1天 |
| 6 | 前端趋势分析页面 | 1天 |
| 7 | 集成测试和优化 | 0.5天 |
| **总计** | | **5天** |

---

## 附录：完整代码文件

详细代码实现请参考：
- [后端代码实现](./运动员数据分析-后端代码.md)
- [前端代码实现](./运动员数据分析-前端代码.md)
