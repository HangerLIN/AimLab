# 运动员数据分析功能 - 后端代码实现

## 1. DTO类

### 1.1 AthleteCompareDTO.java

```java
package com.aimlab.dto;

import lombok.Data;
import java.math.BigDecimal;

/**
 * 运动员对比数据DTO
 */
@Data
public class AthleteCompareDTO {
    private Long athleteId;
    private String athleteName;
    private String athleteLevel;
    private BigDecimal avgScore;
    private BigDecimal maxScore;
    private BigDecimal minScore;
    private BigDecimal stabilityIndex;
    private Long totalShots;
    private Long sessionCount;
    private BigDecimal perfectRate;
    private BigDecimal highScoreRate;
    private BigDecimal stabilityScore;
}
```

### 1.2 TrendDataDTO.java

```java
package com.aimlab.dto;

import lombok.Data;
import java.math.BigDecimal;
import java.time.LocalDate;

/**
 * 趋势数据点DTO
 */
@Data
public class TrendDataDTO {
    private String period;
    private Integer weekNumber;
    private LocalDate weekStartDate;
    private BigDecimal avgScore;
    private BigDecimal maxScore;
    private BigDecimal minScore;
    private BigDecimal stabilityIndex;
    private Long totalShots;
    private Long sessionCount;
    private BigDecimal movingAverage;
    private BigDecimal predictedScore;
    private Boolean isPredicted;
}
```

### 1.3 TrendAnalysisResultDTO.java

```java
package com.aimlab.dto;

import lombok.Data;
import java.math.BigDecimal;
import java.util.List;

/**
 * 趋势分析结果DTO
 */
@Data
public class TrendAnalysisResultDTO {
    private Long athleteId;
    private String athleteName;
    private Integer analyzedWeeks;
    private List<TrendDataDTO> trendData;
    private String trendDirection;
    private BigDecimal trendSlope;
    private List<TrendDataDTO> predictions;
    private TrendSummary summary;

    @Data
    public static class TrendSummary {
        private BigDecimal periodHighest;
        private BigDecimal periodLowest;
        private BigDecimal periodAverage;
        private BigDecimal improvement;
        private String bestWeek;
        private String worstWeek;
    }
}
```

### 1.4 CompareRequestDTO.java

```java
package com.aimlab.dto;

import lombok.Data;
import java.time.LocalDateTime;
import java.util.List;

/**
 * 对比分析请求DTO
 */
@Data
public class CompareRequestDTO {
    private List<Long> athleteIds;
    private String level;
    private LocalDateTime startTime;
    private LocalDateTime endTime;
    private String projectType;
    private Integer maxCount;
}
```

---

## 2. Mapper接口

### 2.1 AdvancedAnalyticsMapper.java

```java
package com.aimlab.mapper;

import com.aimlab.dto.AthleteCompareDTO;
import com.aimlab.dto.TrendDataDTO;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.time.LocalDateTime;
import java.util.List;

@Mapper
public interface AdvancedAnalyticsMapper {

    List<AthleteCompareDTO> getAthleteCompareData(
            @Param("level") String level,
            @Param("athleteIds") List<Long> athleteIds,
            @Param("startTime") LocalDateTime startTime,
            @Param("endTime") LocalDateTime endTime,
            @Param("projectType") String projectType,
            @Param("limit") Integer limit);

    List<TrendDataDTO> getWeeklyTrendData(
            @Param("athleteId") Long athleteId,
            @Param("weeks") Integer weeks,
            @Param("projectType") String projectType);

    List<AthleteCompareDTO> getAthletesByIds(
            @Param("athleteIds") List<Long> athleteIds,
            @Param("startTime") LocalDateTime startTime,
            @Param("endTime") LocalDateTime endTime,
            @Param("projectType") String projectType);
}
```

### 2.2 AdvancedAnalyticsMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aimlab.mapper.AdvancedAnalyticsMapper">

    <resultMap id="athleteCompareMap" type="com.aimlab.dto.AthleteCompareDTO">
        <id property="athleteId" column="athlete_id"/>
        <result property="athleteName" column="athlete_name"/>
        <result property="athleteLevel" column="athlete_level"/>
        <result property="avgScore" column="avg_score"/>
        <result property="maxScore" column="max_score"/>
        <result property="minScore" column="min_score"/>
        <result property="stabilityIndex" column="stability_index"/>
        <result property="totalShots" column="total_shots"/>
        <result property="sessionCount" column="session_count"/>
        <result property="perfectRate" column="perfect_rate"/>
        <result property="highScoreRate" column="high_score_rate"/>
    </resultMap>

    <resultMap id="trendDataMap" type="com.aimlab.dto.TrendDataDTO">
        <result property="period" column="week_period"/>
        <result property="weekNumber" column="week_number"/>
        <result property="weekStartDate" column="week_start_date"/>
        <result property="avgScore" column="avg_score"/>
        <result property="maxScore" column="max_score"/>
        <result property="minScore" column="min_score"/>
        <result property="stabilityIndex" column="stability_index"/>
        <result property="totalShots" column="total_shots"/>
        <result property="sessionCount" column="session_count"/>
    </resultMap>

    <select id="getAthleteCompareData" resultMap="athleteCompareMap">
        SELECT 
            a.id AS athlete_id,
            a.name AS athlete_name,
            a.level AS athlete_level,
            ROUND(AVG(sr.score), 2) AS avg_score,
            MAX(sr.score) AS max_score,
            MIN(sr.score) AS min_score,
            ROUND(IFNULL(STDDEV_POP(sr.score), 0), 2) AS stability_index,
            COUNT(*) AS total_shots,
            COUNT(DISTINCT sr.training_session_id) AS session_count,
            ROUND(SUM(CASE WHEN sr.score = 10 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS perfect_rate,
            ROUND(SUM(CASE WHEN sr.score >= 9 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS high_score_rate
        FROM athletes a
        INNER JOIN shooting_records sr ON a.id = sr.athlete_id
        LEFT JOIN training_sessions ts ON sr.training_session_id = ts.id
        WHERE sr.record_type = 'TRAINING'
        <if test="level != null and level != ''">
            AND a.level = #{level}
        </if>
        <if test="athleteIds != null and athleteIds.size() > 0">
            AND a.id IN
            <foreach collection="athleteIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
        <if test="startTime != null">
            AND sr.shot_at &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND sr.shot_at &lt;= #{endTime}
        </if>
        <if test="projectType != null and projectType != ''">
            AND ts.project_type = #{projectType}
        </if>
        GROUP BY a.id, a.name, a.level
        HAVING COUNT(*) >= 10
        ORDER BY avg_score DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <select id="getWeeklyTrendData" resultMap="trendDataMap">
        SELECT 
            DATE_FORMAT(sr.shot_at, '%Y-W%v') AS week_period,
            YEARWEEK(sr.shot_at, 1) AS week_number,
            MIN(DATE(sr.shot_at)) AS week_start_date,
            ROUND(AVG(sr.score), 2) AS avg_score,
            MAX(sr.score) AS max_score,
            MIN(sr.score) AS min_score,
            ROUND(IFNULL(STDDEV_POP(sr.score), 0), 2) AS stability_index,
            COUNT(*) AS total_shots,
            COUNT(DISTINCT sr.training_session_id) AS session_count
        FROM shooting_records sr
        LEFT JOIN training_sessions ts ON sr.training_session_id = ts.id
        WHERE sr.athlete_id = #{athleteId}
          AND sr.record_type = 'TRAINING'
          AND sr.shot_at >= DATE_SUB(NOW(), INTERVAL #{weeks} WEEK)
        <if test="projectType != null and projectType != ''">
            AND ts.project_type = #{projectType}
        </if>
        GROUP BY week_period, week_number
        HAVING COUNT(*) >= 5
        ORDER BY week_number ASC
    </select>

    <select id="getAthletesByIds" resultMap="athleteCompareMap">
        SELECT 
            a.id AS athlete_id,
            a.name AS athlete_name,
            a.level AS athlete_level,
            ROUND(AVG(sr.score), 2) AS avg_score,
            MAX(sr.score) AS max_score,
            MIN(sr.score) AS min_score,
            ROUND(IFNULL(STDDEV_POP(sr.score), 0), 2) AS stability_index,
            COUNT(*) AS total_shots,
            COUNT(DISTINCT sr.training_session_id) AS session_count,
            ROUND(SUM(CASE WHEN sr.score = 10 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS perfect_rate,
            ROUND(SUM(CASE WHEN sr.score >= 9 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS high_score_rate
        FROM athletes a
        INNER JOIN shooting_records sr ON a.id = sr.athlete_id
        LEFT JOIN training_sessions ts ON sr.training_session_id = ts.id
        WHERE sr.record_type = 'TRAINING'
          AND a.id IN
            <foreach collection="athleteIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        <if test="startTime != null">
            AND sr.shot_at &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND sr.shot_at &lt;= #{endTime}
        </if>
        <if test="projectType != null and projectType != ''">
            AND ts.project_type = #{projectType}
        </if>
        GROUP BY a.id, a.name, a.level
        ORDER BY avg_score DESC
    </select>

</mapper>
```

---

## 3. Service层

### 3.1 AdvancedAnalyticsService.java

```java
package com.aimlab.service;

import com.aimlab.dto.*;
import com.aimlab.mapper.AdvancedAnalyticsMapper;
import com.aimlab.mapper.AthleteMapper;
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.io.ByteArrayOutputStream;
import java.math.BigDecimal;
import java.math.RoundingMode;
import java.time.LocalDateTime;
import java.util.*;

@Service
public class AdvancedAnalyticsService {

    private static final int DEFAULT_WEEKS = 12;
    private static final int MOVING_AVERAGE_WINDOW = 3;
    private static final int PREDICTION_WEEKS = 2;

    @Autowired
    private AdvancedAnalyticsMapper analyticsMapper;

    @Autowired
    private AthleteMapper athleteMapper;

    /**
     * 运动员对比分析
     */
    public List<AthleteCompareDTO> compareAthletes(CompareRequestDTO request) {
        LocalDateTime endTime = request.getEndTime() != null ? 
                request.getEndTime() : LocalDateTime.now();
        LocalDateTime startTime = request.getStartTime() != null ? 
                request.getStartTime() : endTime.minusDays(30);
        
        int maxCount = request.getMaxCount() != null ? request.getMaxCount() : 5;
        
        List<AthleteCompareDTO> result;
        
        if (request.getAthleteIds() != null && !request.getAthleteIds().isEmpty()) {
            result = analyticsMapper.getAthletesByIds(
                    request.getAthleteIds(), startTime, endTime, request.getProjectType());
        } else {
            result = analyticsMapper.getAthleteCompareData(
                    request.getLevel(), null, startTime, endTime, 
                    request.getProjectType(), maxCount);
        }
        
        // 计算稳定性得分
        for (AthleteCompareDTO dto : result) {
            if (dto.getStabilityIndex() != null) {
                BigDecimal score = BigDecimal.valueOf(100)
                        .subtract(dto.getStabilityIndex().multiply(BigDecimal.TEN));
                dto.setStabilityScore(score.max(BigDecimal.ZERO));
            } else {
                dto.setStabilityScore(BigDecimal.valueOf(100));
            }
        }
        
        return result;
    }

    /**
     * 趋势分析
     */
    public TrendAnalysisResultDTO getTrendAnalysis(Long athleteId, Integer weeks, String projectType) {
        int analyzeWeeks = weeks != null && weeks > 0 ? weeks : DEFAULT_WEEKS;
        
        List<TrendDataDTO> rawData = analyticsMapper.getWeeklyTrendData(
                athleteId, analyzeWeeks, projectType);
        
        if (rawData.isEmpty()) {
            TrendAnalysisResultDTO emptyResult = new TrendAnalysisResultDTO();
            emptyResult.setAthleteId(athleteId);
            emptyResult.setAnalyzedWeeks(0);
            emptyResult.setTrendData(Collections.emptyList());
            emptyResult.setTrendDirection("STABLE");
            return emptyResult;
        }
        
        // 计算移动平均
        calculateMovingAverage(rawData, MOVING_AVERAGE_WINDOW);
        rawData.forEach(d -> d.setIsPredicted(false));
        
        // 计算趋势斜率
        BigDecimal slope = calculateTrendSlope(rawData);
        String direction = determineTrendDirection(slope);
        
        // 生成预测
        List<TrendDataDTO> predictions = predictFutureWeeks(rawData, PREDICTION_WEEKS, slope);
        
        // 计算摘要
        TrendAnalysisResultDTO.TrendSummary summary = calculateSummary(rawData);
        
        // 获取运动员信息
        var athlete = athleteMapper.findById(athleteId);
        
        TrendAnalysisResultDTO result = new TrendAnalysisResultDTO();
        result.setAthleteId(athleteId);
        result.setAthleteName(athlete != null ? athlete.getName() : "未知运动员");
        result.setAnalyzedWeeks(rawData.size());
        result.setTrendData(rawData);
        result.setTrendDirection(direction);
        result.setTrendSlope(slope);
        result.setPredictions(predictions);
        result.setSummary(summary);
        
        return result;
    }

    private void calculateMovingAverage(List<TrendDataDTO> data, int window) {
        for (int i = 0; i < data.size(); i++) {
            int start = Math.max(0, i - window + 1);
            BigDecimal sum = BigDecimal.ZERO;
            int count = 0;
            
            for (int j = start; j <= i; j++) {
                if (data.get(j).getAvgScore() != null) {
                    sum = sum.add(data.get(j).getAvgScore());
                    count++;
                }
            }
            
            if (count > 0) {
                data.get(i).setMovingAverage(
                        sum.divide(BigDecimal.valueOf(count), 2, RoundingMode.HALF_UP));
            }
        }
    }

    private BigDecimal calculateTrendSlope(List<TrendDataDTO> data) {
        if (data.size() < 2) return BigDecimal.ZERO;
        
        int n = data.size();
        double sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
        
        for (int i = 0; i < n; i++) {
            double x = i;
            double y = data.get(i).getAvgScore() != null ? 
                    data.get(i).getAvgScore().doubleValue() : 0;
            sumX += x;
            sumY += y;
            sumXY += x * y;
            sumX2 += x * x;
        }
        
        double denominator = n * sumX2 - sumX * sumX;
        if (denominator == 0) return BigDecimal.ZERO;
        
        double slope = (n * sumXY - sumX * sumY) / denominator;
        return BigDecimal.valueOf(slope).setScale(4, RoundingMode.HALF_UP);
    }

    private String determineTrendDirection(BigDecimal slope) {
        double slopeValue = slope.doubleValue();
        if (slopeValue > 0.05) return "UP";
        else if (slopeValue < -0.05) return "DOWN";
        else return "STABLE";
    }

    private List<TrendDataDTO> predictFutureWeeks(List<TrendDataDTO> data, 
                                                   int predictWeeks, 
                                                   BigDecimal slope) {
        if (data.isEmpty()) return Collections.emptyList();
        
        List<TrendDataDTO> predictions = new ArrayList<>();
        TrendDataDTO lastData = data.get(data.size() - 1);
        BigDecimal lastScore = lastData.getMovingAverage() != null ? 
                lastData.getMovingAverage() : lastData.getAvgScore();
        
        if (lastScore == null) return Collections.emptyList();
        
        for (int i = 1; i <= predictWeeks; i++) {
            TrendDataDTO prediction = new TrendDataDTO();
            prediction.setPeriod("预测第" + i + "周");
            prediction.setWeekNumber(lastData.getWeekNumber() + i);
            prediction.setIsPredicted(true);
            
            BigDecimal predictedScore = lastScore.add(slope.multiply(BigDecimal.valueOf(i)));
            predictedScore = predictedScore.max(BigDecimal.ZERO).min(BigDecimal.TEN);
            prediction.setPredictedScore(predictedScore.setScale(2, RoundingMode.HALF_UP));
            prediction.setAvgScore(prediction.getPredictedScore());
            
            predictions.add(prediction);
        }
        
        return predictions;
    }

    private TrendAnalysisResultDTO.TrendSummary calculateSummary(List<TrendDataDTO> data) {
        TrendAnalysisResultDTO.TrendSummary summary = new TrendAnalysisResultDTO.TrendSummary();
        
        if (data.isEmpty()) return summary;
        
        BigDecimal highest = BigDecimal.ZERO;
        BigDecimal lowest = BigDecimal.valueOf(10);
        BigDecimal sum = BigDecimal.ZERO;
        String bestWeek = "", worstWeek = "";
        
        for (TrendDataDTO d : data) {
            if (d.getAvgScore() != null) {
                if (d.getAvgScore().compareTo(highest) > 0) {
                    highest = d.getAvgScore();
                    bestWeek = d.getPeriod();
                }
                if (d.getAvgScore().compareTo(lowest) < 0) {
                    lowest = d.getAvgScore();
                    worstWeek = d.getPeriod();
                }
                sum = sum.add(d.getAvgScore());
            }
        }
        
        summary.setPeriodHighest(highest);
        summary.setPeriodLowest(lowest);
        summary.setPeriodAverage(sum.divide(BigDecimal.valueOf(data.size()), 2, RoundingMode.HALF_UP));
        summary.setBestWeek(bestWeek);
        summary.setWorstWeek(worstWeek);
        
        if (data.size() >= 2) {
            BigDecimal first = data.get(0).getAvgScore();
            BigDecimal last = data.get(data.size() - 1).getAvgScore();
            if (first != null && last != null) {
                summary.setImprovement(last.subtract(first).setScale(2, RoundingMode.HALF_UP));
            }
        }
        
        return summary;
    }

    /**
     * 导出对比数据
     */
    public ExportFile exportCompareData(List<AthleteCompareDTO> data, String format) {
        try (Workbook workbook = new XSSFWorkbook()) {
            Sheet sheet = workbook.createSheet("运动员对比分析");
            
            Row header = sheet.createRow(0);
            String[] headers = {"运动员ID", "姓名", "级别", "平均环数", "最高环数", 
                    "最低环数", "稳定性指数", "射击总数", "训练场次", "10环率(%)", "9环以上率(%)"};
            for (int i = 0; i < headers.length; i++) {
                header.createCell(i).setCellValue(headers[i]);
            }
            
            int rowIndex = 1;
            for (AthleteCompareDTO dto : data) {
                Row row = sheet.createRow(rowIndex++);
                row.createCell(0).setCellValue(dto.getAthleteId() != null ? dto.getAthleteId() : 0);
                row.createCell(1).setCellValue(dto.getAthleteName() != null ? dto.getAthleteName() : "");
                row.createCell(2).setCellValue(dto.getAthleteLevel() != null ? dto.getAthleteLevel() : "");
                row.createCell(3).setCellValue(toDouble(dto.getAvgScore()));
                row.createCell(4).setCellValue(toDouble(dto.getMaxScore()));
                row.createCell(5).setCellValue(toDouble(dto.getMinScore()));
                row.createCell(6).setCellValue(toDouble(dto.getStabilityIndex()));
                row.createCell(7).setCellValue(dto.getTotalShots() != null ? dto.getTotalShots() : 0);
                row.createCell(8).setCellValue(dto.getSessionCount() != null ? dto.getSessionCount() : 0);
                row.createCell(9).setCellValue(toDouble(dto.getPerfectRate()));
                row.createCell(10).setCellValue(toDouble(dto.getHighScoreRate()));
            }
            
            ByteArrayOutputStream bos = new ByteArrayOutputStream();
            workbook.write(bos);
            
            String fileName = "athlete-compare-" + System.currentTimeMillis() + ".xlsx";
            return new ExportFile(fileName, 
                    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", 
                    bos.toByteArray());
        } catch (Exception e) {
            throw new RuntimeException("导出对比数据失败: " + e.getMessage(), e);
        }
    }

    /**
     * 导出趋势数据
     */
    public ExportFile exportTrendData(TrendAnalysisResultDTO data) {
        try (Workbook workbook = new XSSFWorkbook()) {
            Sheet sheet = workbook.createSheet("趋势分析");
            
            Row header = sheet.createRow(0);
            String[] headers = {"周期", "平均环数", "最高环数", "最低环数", 
                    "稳定性指数", "移动平均", "射击总数", "训练场次", "是否预测"};
            for (int i = 0; i < headers.length; i++) {
                header.createCell(i).setCellValue(headers[i]);
            }
            
            int rowIndex = 1;
            for (TrendDataDTO dto : data.getTrendData()) {
                fillTrendRow(sheet.createRow(rowIndex++), dto);
            }
            for (TrendDataDTO dto : data.getPredictions()) {
                fillTrendRow(sheet.createRow(rowIndex++), dto);
            }
            
            ByteArrayOutputStream bos = new ByteArrayOutputStream();
            workbook.write(bos);
            
            String fileName = "trend-analysis-" + data.getAthleteId() + ".xlsx";
            return new ExportFile(fileName, 
                    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", 
                    bos.toByteArray());
        } catch (Exception e) {
            throw new RuntimeException("导出趋势数据失败: " + e.getMessage(), e);
        }
    }

    private void fillTrendRow(Row row, TrendDataDTO dto) {
        row.createCell(0).setCellValue(dto.getPeriod() != null ? dto.getPeriod() : "");
        row.createCell(1).setCellValue(toDouble(dto.getAvgScore()));
        row.createCell(2).setCellValue(toDouble(dto.getMaxScore()));
        row.createCell(3).setCellValue(toDouble(dto.getMinScore()));
        row.createCell(4).setCellValue(toDouble(dto.getStabilityIndex()));
        row.createCell(5).setCellValue(toDouble(dto.getMovingAverage()));
        row.createCell(6).setCellValue(dto.getTotalShots() != null ? dto.getTotalShots() : 0);
        row.createCell(7).setCellValue(dto.getSessionCount() != null ? dto.getSessionCount() : 0);
        row.createCell(8).setCellValue(Boolean.TRUE.equals(dto.getIsPredicted()) ? "是" : "否");
    }

    private double toDouble(BigDecimal value) {
        return value != null ? value.doubleValue() : 0.0;
    }
}
```

---

## 4. Controller层

### 4.1 AnalyticsController.java

```java
package com.aimlab.controller;

import cn.dev33.satoken.annotation.SaCheckLogin;
import com.aimlab.dto.*;
import com.aimlab.service.AdvancedAnalyticsService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.http.*;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.*;

@Tag(name = "数据分析", description = "运动员数据对比与趋势分析接口")
@RestController
@RequestMapping("/api/analytics")
public class AnalyticsController {

    @Autowired
    private AdvancedAnalyticsService analyticsService;

    @Operation(summary = "运动员对比分析")
    @SaCheckLogin
    @PostMapping("/compare")
    public ResponseEntity<?> compareAthletes(@RequestBody CompareRequestDTO request) {
        try {
            List<AthleteCompareDTO> result = analyticsService.compareAthletes(request);
            
            Map<String, Object> response = new HashMap<>();
            response.put("success", true);
            response.put("data", result);
            response.put("count", result.size());
            
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(Map.of("success", false, "message", e.getMessage()));
        }
    }

    @Operation(summary = "快速对比分析")
    @SaCheckLogin
    @GetMapping("/compare")
    public ResponseEntity<?> quickCompare(
            @RequestParam(required = false) String level,
            @RequestParam(required = false) String athleteIds,
            @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime startTime,
            @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime endTime,
            @RequestParam(required = false) String projectType,
            @RequestParam(defaultValue = "5") Integer maxCount) {
        
        CompareRequestDTO request = new CompareRequestDTO();
        request.setLevel(level);
        request.setStartTime(startTime);
        request.setEndTime(endTime);
        request.setProjectType(projectType);
        request.setMaxCount(maxCount);
        
        if (athleteIds != null && !athleteIds.trim().isEmpty()) {
            List<Long> ids = Arrays.stream(athleteIds.split(","))
                    .map(String::trim)
                    .filter(s -> !s.isEmpty())
                    .map(Long::parseLong)
                    .toList();
            request.setAthleteIds(ids);
        }
        
        return compareAthletes(request);
    }

    @Operation(summary = "趋势分析")
    @SaCheckLogin
    @GetMapping("/trend/{athleteId}")
    public ResponseEntity<?> getTrendAnalysis(
            @PathVariable Long athleteId,
            @RequestParam(defaultValue = "12") Integer weeks,
            @RequestParam(required = false) String projectType) {
        
        try {
            TrendAnalysisResultDTO result = analyticsService.getTrendAnalysis(athleteId, weeks, projectType);
            return ResponseEntity.ok(Map.of("success", true, "data", result));
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(Map.of("success", false, "message", e.getMessage()));
        }
    }

    @Operation(summary = "导出对比数据")
    @SaCheckLogin
    @PostMapping("/compare/export")
    public ResponseEntity<?> exportCompareData(@RequestBody CompareRequestDTO request) {
        try {
            List<AthleteCompareDTO> data = analyticsService.compareAthletes(request);
            ExportFile file = analyticsService.exportCompareData(data, "xlsx");
            
            return ResponseEntity.ok()
                    .header(HttpHeaders.CONTENT_DISPOSITION, 
                            "attachment; filename=\"" + file.getFileName() + "\"")
                    .contentType(MediaType.parseMediaType(file.getContentType()))
                    .body(file.getData());
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(Map.of("success", false, "message", e.getMessage()));
        }
    }

    @Operation(summary = "导出趋势数据")
    @SaCheckLogin
    @GetMapping("/trend/{athleteId}/export")
    public ResponseEntity<?> exportTrendData(
            @PathVariable Long athleteId,
            @RequestParam(defaultValue = "12") Integer weeks,
            @RequestParam(required = false) String projectType) {
        
        try {
            TrendAnalysisResultDTO data = analyticsService.getTrendAnalysis(athleteId, weeks, projectType);
            ExportFile file = analyticsService.exportTrendData(data);
            
            return ResponseEntity.ok()
                    .header(HttpHeaders.CONTENT_DISPOSITION, 
                            "attachment; filename=\"" + file.getFileName() + "\"")
                    .contentType(MediaType.parseMediaType(file.getContentType()))
                    .body(file.getData());
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(Map.of("success", false, "message", e.getMessage()));
        }
    }

    @Operation(summary = "获取级别列表")
    @GetMapping("/levels")
    public ResponseEntity<?> getAvailableLevels() {
        List<String> levels = Arrays.asList("国家级", "省级", "市级", "业余");
        return ResponseEntity.ok(Map.of("success", true, "levels", levels));
    }
}
```
