<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aimlab.mapper.MessageMapper">
    
    <resultMap id="MessageResultMap" type="com.aimlab.entity.Message">
        <id property="id" column="id"/>
        <result property="senderId" column="sender_id"/>
        <result property="receiverId" column="receiver_id"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="type" column="type"/>
        <result property="isRead" column="is_read"/>
        <result property="readAt" column="read_at"/>
        <result property="createdAt" column="created_at"/>
        <result property="senderName" column="sender_name"/>
        <result property="receiverName" column="receiver_name"/>
    </resultMap>
    
    <!-- 插入消息 -->
    <insert id="insert" parameterType="com.aimlab.entity.Message" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO message (sender_id, receiver_id, title, content, type, is_read, created_at)
        VALUES (#{senderId}, #{receiverId}, #{title}, #{content}, #{type}, 0, NOW())
    </insert>
    
    <!-- 根据ID查询消息 -->
    <select id="findById" resultMap="MessageResultMap">
        SELECT m.*, 
               s.username as sender_name,
               r.username as receiver_name
        FROM message m
        LEFT JOIN users s ON m.sender_id = s.id
        LEFT JOIN users r ON m.receiver_id = r.id
        WHERE m.id = #{id}
    </select>
    
    <!-- 查询用户的消息列表 -->
    <select id="findByReceiverId" resultMap="MessageResultMap">
        SELECT m.*, 
               s.username as sender_name
        FROM message m
        LEFT JOIN users s ON m.sender_id = s.id
        WHERE m.receiver_id = #{receiverId}
        <if test="type != null and type != ''">
            AND m.type = #{type}
        </if>
        <if test="isRead != null">
            AND m.is_read = #{isRead}
        </if>
        ORDER BY m.created_at DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计用户的消息数量 -->
    <select id="countByReceiverId" resultType="int">
        SELECT COUNT(*) FROM message
        WHERE receiver_id = #{receiverId}
        <if test="type != null and type != ''">
            AND type = #{type}
        </if>
        <if test="isRead != null">
            AND is_read = #{isRead}
        </if>
    </select>
    
    <!-- 统计用户未读消息数量 -->
    <select id="countUnreadByReceiverId" resultType="int">
        SELECT COUNT(*) FROM message
        WHERE receiver_id = #{receiverId} AND is_read = 0
    </select>
    
    <!-- 标记消息为已读 -->
    <update id="markAsRead">
        UPDATE message SET is_read = 1, read_at = NOW()
        WHERE id = #{id}
    </update>
    
    <!-- 批量标记消息为已读 -->
    <update id="markAllAsRead">
        UPDATE message SET is_read = 1, read_at = NOW()
        WHERE receiver_id = #{receiverId} AND is_read = 0
    </update>
    
    <!-- 删除消息 -->
    <delete id="deleteById">
        DELETE FROM message WHERE id = #{id}
    </delete>
    
    <!-- 批量删除消息 -->
    <delete id="deleteByIds">
        DELETE FROM message 
        WHERE receiver_id = #{receiverId} 
        AND id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
</mapper>
