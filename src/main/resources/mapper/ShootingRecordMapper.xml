<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aimlab.mapper.ShootingRecordMapper">
    <!-- 结果映射 -->
    <resultMap id="shootingRecordMap" type="com.aimlab.entity.ShootingRecord">
        <id property="id" column="id"/>
        <result property="recordType" column="record_type"/>
        <result property="athleteId" column="athlete_id"/>
        <result property="competitionId" column="competition_id"/>
        <result property="trainingSessionId" column="training_session_id"/>
        <result property="roundNumber" column="round_number"/>
        <result property="shotNumber" column="shot_number"/>
        <result property="x" column="x"/>
        <result property="y" column="y"/>
        <result property="score" column="score"/>
        <result property="shotAt" column="shot_at"/>
        <result property="userId" column="user_id"/>
    </resultMap>
    
    <!-- 插入射击记录 -->
    <insert id="insert" parameterType="com.aimlab.entity.ShootingRecord" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO shooting_records (
            record_type, athlete_id, competition_id, training_session_id, 
            round_number, shot_number, x, y, score, shot_at, user_id
        ) VALUES (
            #{recordType}, #{athleteId}, #{competitionId}, #{trainingSessionId}, 
            #{roundNumber}, #{shotNumber}, #{x}, #{y}, #{score}, #{shotAt}, #{userId}
        )
    </insert>
    
    <!-- 根据ID查询射击记录 -->
    <select id="findById" resultMap="shootingRecordMap">
        SELECT * FROM shooting_records WHERE id = #{id}
    </select>
    
    <!-- 根据运动员ID查询射击记录 -->
    <select id="findByAthleteId" resultMap="shootingRecordMap">
        SELECT * FROM shooting_records 
        WHERE athlete_id = #{athleteId}
        ORDER BY shot_at DESC
        <if test="limit > 0">
            LIMIT #{limit}
        </if>
    </select>
    
    <!-- 根据比赛ID查询射击记录 -->
    <select id="findByCompetitionId" resultMap="shootingRecordMap">
        SELECT * FROM shooting_records 
        WHERE competition_id = #{competitionId}
        ORDER BY athlete_id, round_number, shot_number
    </select>
    
    <!-- 根据训练场次ID查询射击记录 -->
    <select id="findByTrainingSessionId" resultMap="shootingRecordMap">
        SELECT * FROM shooting_records 
        WHERE training_session_id = #{trainingSessionId}
        ORDER BY shot_at
    </select>
    
    <!-- 根据比赛ID和运动员ID查询射击记录 -->
    <select id="findByCompetitionIdAndAthleteId" resultMap="shootingRecordMap">
        SELECT * FROM shooting_records 
        WHERE competition_id = #{competitionId} AND athlete_id = #{athleteId}
        ORDER BY round_number, shot_number
    </select>
    
    <!-- 根据比赛ID、运动员ID和轮次查询射击记录 -->
    <select id="findByCompetitionIdAndAthleteIdAndRound" resultMap="shootingRecordMap">
        SELECT * FROM shooting_records 
        WHERE competition_id = #{competitionId} 
          AND athlete_id = #{athleteId}
          AND round_number = #{roundNumber}
        ORDER BY shot_number
    </select>
    
    <!-- 查询运动员在指定时间范围内的射击记录 -->
    <select id="findByAthleteIdAndTimeRange" resultMap="shootingRecordMap">
        SELECT * FROM shooting_records 
        WHERE athlete_id = #{athleteId}
          AND shot_at BETWEEN #{startTime} AND #{endTime}
        ORDER BY shot_at
    </select>
    
    <!-- 添加getLiveRanking方法的SQL实现 -->
    <select id="getLiveRanking" resultType="com.aimlab.dto.RankingItemDTO">
        SELECT
            sr.athlete_id as athleteId,
            a.name as athleteName,
            SUM(sr.score) as totalScore,
            COUNT(sr.id) as totalShots,
            MAX(sr.shot_at) as lastShotTime
        FROM
            shooting_records sr
        JOIN
            athletes a ON sr.athlete_id = a.id
        WHERE
            sr.competition_id = #{competitionId}
        GROUP BY
            sr.athlete_id, a.name
        ORDER BY
            totalScore DESC, totalShots ASC
    </select>
    
    <!-- 统计运动员在指定比赛中的射击次数 -->
    <select id="countByCompetitionIdAndAthleteId" resultType="int">
        SELECT COUNT(*) FROM shooting_records 
        WHERE competition_id = #{competitionId} AND athlete_id = #{athleteId}
    </select>
    
    <!-- 获取所有射击记录的平均成绩 -->
    <select id="getAverageScore" resultType="java.math.BigDecimal">
        SELECT ROUND(AVG(score), 2) FROM shooting_records
    </select>
    
    <!-- 按运动员统计训练次数和平均成绩 -->
    <select id="getAthleteTrainingStats" resultType="java.util.Map">
        SELECT 
            sr.athlete_id as athleteId,
            a.name as name,
            a.level as level,
            COUNT(DISTINCT sr.training_session_id) as trainingCount,
            ROUND(AVG(sr.score), 2) as avgScore
        FROM shooting_records sr
        JOIN athletes a ON sr.athlete_id = a.id
        WHERE sr.training_session_id IS NOT NULL
        GROUP BY sr.athlete_id, a.name, a.level
        ORDER BY avgScore DESC, trainingCount DESC
        LIMIT 10
    </select>
    
    <!-- 获取成绩分布统计（按分数段） -->
    <select id="getScoreDistribution" resultType="java.util.Map">
        SELECT 
            CASE 
                WHEN score >= 10 THEN '10环'
                WHEN score >= 9 THEN '9环'
                WHEN score >= 8 THEN '8环'
                WHEN score >= 7 THEN '7环'
                WHEN score >= 6 THEN '6环'
                ELSE '6环以下'
            END as scoreRange,
            COUNT(*) as count
        FROM shooting_records
        GROUP BY 
            CASE 
                WHEN score >= 10 THEN '10环'
                WHEN score >= 9 THEN '9环'
                WHEN score >= 8 THEN '8环'
                WHEN score >= 7 THEN '7环'
                WHEN score >= 6 THEN '6环'
                ELSE '6环以下'
            END
        ORDER BY 
            CASE scoreRange
                WHEN '10环' THEN 1
                WHEN '9环' THEN 2
                WHEN '8环' THEN 3
                WHEN '7环' THEN 4
                WHEN '6环' THEN 5
                ELSE 6
            END
    </select>
</mapper> 